function recalcLevelBounds(){level.movementMask=level.dat.concat([]),level.rigidMovementAppliedMask=level.dat.concat([]),level.rigidGroupIndexMask=level.dat.concat([]),level.commandQueue=[];for(var a=0;a<level.movementMask.length;a++)level.movementMask[a]=0,level.rigidMovementAppliedMask[a]=0,level.rigidGroupIndexMask[a]=0}function addLeftColumn(){var a=1<<state.backgroundid;for(var b=0;b<level.height;b++)level.dat.splice(b,0,a);level.width++,recalcLevelBounds(),columnAdded=!0}function addRightColumn(){var a=1<<state.backgroundid;for(var b=0;b<level.height;b++)level.dat.push(a);level.width++,recalcLevelBounds(),columnAdded=!0}function addTopRow(){var a=1<<state.backgroundid;for(var b=level.width-1;b>=0;b--)level.dat.splice(b*level.height,0,a);level.height++,recalcLevelBounds(),columnAdded=!0}function addBottomRow(){var a=1<<state.backgroundid;for(var b=level.width-1;b>=0;b--)level.dat.splice(level.height+b*level.height,0,a);level.height++,recalcLevelBounds(),columnAdded=!0}function removeLeftColumn(){if(level.width<=1)return;var a=1<<state.backgroundid;for(var b=0;b<level.height;b++)level.dat.splice(0,1);level.width--,recalcLevelBounds(),columnAdded=!0}function removeRightColumn(){if(level.width<=1)return;var a=1<<state.backgroundid;for(var b=0;b<level.height;b++)level.dat.splice(level.dat.length-1,1);level.width--,recalcLevelBounds(),columnAdded=!0}function removeTopRow(){if(level.height<=1)return;var a=1<<state.backgroundid;for(var b=level.width-1;b>=0;b--)level.dat.splice(b*level.height,1);level.height--,recalcLevelBounds(),columnAdded=!0}function removeBottomRow(){if(level.height<=1)return;var a=1<<state.backgroundid;for(var b=level.width-1;b>=0;b--)level.dat.splice(level.height-1+b*level.height,1);level.height--,recalcLevelBounds(),columnAdded=!0}function CountBits(a){return a=(a&m1)+(a>>1&m1),a=(a&m2)+(a>>2&m2),a=(a&m4)+(a>>4&m4),a=(a&m8)+(a>>8&m8),a=(a&m16)+(a>>16&m16),a}function matchGlyph(a,b){if(a in b)return b[a];var c=-1,d;for(var e in b)if(b.hasOwnProperty(e)&&e==(e&a)){var f=CountBits(e);f>c&&(c=f,d=b[e])}return c>0?d:(logErrorNoLine("Wasn't able to approximate a glyph value for some tiles, using '.' as a placeholder.",!0),".")}function printLevel(){var a={},b=0;for(var c in state.glyphDict)if(state.glyphDict.hasOwnProperty(c)&&c.length===1){var d=state.glyphDict[c],b=0;for(var e=0;e<d.length;e++){var f=d[e];f>=0&&(b|=1<<f)}a[b]=c;var g=state.layerMasks[state.backgroundlayer],h=b&~g;b in a||(a[b]=c);for(var e=0;e<32;e++){var i=1<<e;if((i&g)!==0){var j=h|i;j in a||(a[j]=c)}}}var k="Printing level contents:<br><br>";for(var l=0;l<level.height;l++){for(var e=0;e<level.width;e++){var m=l+e*level.height,n=level.dat[m],d=matchGlyph(n,a);d in htmlEntityMap&&(d=htmlEntityMap[d]),k+=d}k+="<br>"}consolePrint(k)}function levelEditorClick(a,b){if(mouseCoordY<=-2){var c=editorRowCount-(-mouseCoordY-2)-1,d=mouseCoordX+(screenwidth-1)*c;mouseCoordX===-1?printLevel():mouseCoordX>=0&&d<glyphImages.length&&(glyphSelectedIndex=d,redraw())}else if(mouseCoordX>-1&&mouseCoordY>-1&&mouseCoordX<screenwidth-2&&mouseCoordY<screenheight-2-editorRowCount){var e=glyphImagesCorrespondance[glyphSelectedIndex],f=state.glyphDict[e],g=0;for(var h=0;h<f.length;h++){var i=f[h];i>=0&&(g|=1<<i)}var j=state.layerMasks[state.backgroundlayer];(g&j)===0&&(g|=1<<state.backgroundid);var k=mouseCoordY+mouseCoordX*level.height;level.dat[k]=g,redraw()}else b&&(mouseCoordX===-1?(addLeftColumn(),canvasResize()):mouseCoordX===screenwidth-2&&(addRightColumn(),canvasResize()),mouseCoordY===-1?(addTopRow(),canvasResize()):mouseCoordY===screenheight-2-editorRowCount&&(addBottomRow(),canvasResize()))}function levelEditorRightClick(a,b){if(mouseCoordY===-2)mouseCoordX<=glyphImages.length&&(glyphSelectedIndex=mouseCoordX,redraw());else if(mouseCoordX>-1&&mouseCoordY>-1&&mouseCoordX<screenwidth-2&&mouseCoordY<screenheight-2-editorRowCount){var c=glyphImagesCorrespondance[glyphSelectedIndex],d=state.glyphDict[c],e=1<<state.backgroundid,f=mouseCoordY+mouseCoordX*level.height;level.dat[f]=e,redraw()}else b&&(mouseCoordX===-1?(removeLeftColumn(),canvasResize()):mouseCoordX===screenwidth-2&&(removeRightColumn(),canvasResize()),mouseCoordY===-1?(removeTopRow(),canvasResize()):mouseCoordY===screenheight-2-editorRowCount&&(removeBottomRow(),canvasResize()))}function onMouseDown(a){if(a.button===0&&!a.ctrlKey&&!a.metaKey){lastDownTarget=a.target,keybuffer=[];if(a.target===canvas){setMouseCoord(a),dragging=!0,rightdragging=!1;if(levelEditorOpened)return levelEditorClick(a,!0)}dragging=!1,rightdragging=!1}else if(a.button===2||a.button===0&&(a.ctrlKey||a.metaKey)){dragging=!1,rightdragging=!0;if(levelEditorOpened)return levelEditorRightClick(a,!0)}}function rightClickCanvas(a){return prevent(a)}function onMouseUp(a){dragging=!1,rightdragging=!1}function onKeyDown(a){a=a||window.event;if(keybuffer.indexOf(a.keyCode)>=0)return;lastDownTarget===canvas&&keybuffer.indexOf(a.keyCode)===-1&&(keybuffer.splice(keyRepeatIndex,0,a.keyCode),keyRepeatTimer=0,checkKey(a,!0)),canDump===!0&&(a.keyCode===74&&(a.ctrlKey||a.metaKey)?dumpTestCase():a.keyCode===75&&(a.ctrlKey||a.metaKey)&&makeGIF())}function relMouseCoords(a){var b=0,c=0,d=0,e=0,f=this;do b+=f.offsetLeft-f.scrollLeft,c+=f.offsetTop-f.scrollTop;while(f=f.offsetParent);return d=a.pageX-b,e=a.pageY-c,{x:d,y:e}}function onKeyUp(a){a=a||window.event;var b=keybuffer.indexOf(a.keyCode);b>=0&&(keybuffer.splice(b,1),keyRepeatIndex>=b&&keyRepeatIndex--)}function setMouseCoord(a){var b=canvas.relMouseCoords(a);mouseCoordX=b.x-xoffset,mouseCoordY=b.y-yoffset,mouseCoordX=Math.floor(mouseCoordX/cellwidth),mouseCoordY=Math.floor(mouseCoordY/cellheight)}function mouseMove(a){levelEditorOpened&&(setMouseCoord(a),dragging?levelEditorClick(a,!1):rightdragging&&levelEditorRightClick(a,!1)),redraw()}function mouseOut(){}function prevent(a){return a.preventDefault&&a.preventDefault(),a.stopImmediatePropagation&&a.stopImmediatePropagation(),a.stopPropagation&&a.stopPropagation(),a.returnValue=!1,!1}function checkKey(a,b){if(winning)return;var c=-1;switch(a.keyCode){case 65:case 37:c=1;break;case 38:case 87:c=0;break;case 68:case 39:c=3;break;case 83:case 40:c=2;break;case 13:case 32:case 67:case 88:c=4;break;case 85:case 90:if(textMode===!1)return canDump===!0&&inputHistory.push("undo"),DoUndo(),prevent(a);break;case 82:if(textMode===!1)return canDump===!0&&inputHistory.push("restart"),DoRestart(),prevent(a);break;case 27:if(titleScreen===!1)return goToTitleScreen(),tryPlayTitleSound(),canvasResize(),prevent(a);break;case 69:if(canOpenEditor)return levelEditorOpened=!levelEditorOpened,canvasResize(),prevent(a);break;case 48:case 49:case 50:case 51:case 52:case 53:case 54:case 55:case 56:case 57:if(levelEditorOpened&&b){var d=9;return a.keyCode>=49&&(d=a.keyCode-49),d<glyphImages.length?glyphSelectedIndex=d:consolePrint("Trying to select tile outside of range in level editor."),canvasResize(),prevent(a)}}if(textMode){if(state.levels.length!==0)if(titleScreen){if(titleMode===0)c===4&&b&&titleSelected===!1&&(tryPlayStartGameSound(),titleSelected=!0,messageselected=!1,timer=0,quittingTitleScreen=!0,generateTitleScreen(),canvasResize());else if(c==4&&b)titleSelected===!1&&(tryPlayStartGameSound(),titleSelected=!0,messageselected=!1,timer=0,quittingTitleScreen=!0,generateTitleScreen(),redraw());else if(c===0||c===2)titleSelection=1-titleSelection,generateTitleScreen(),redraw()}else if(c==4&&b){if(unitTesting){nextLevel();return}messageselected===!1&&(messageselected=!0,timer=0,quittingMessageScreen=!0,tryPlayCloseMessageSound(),titleScreen=!1,drawMessageScreen())}}else if(!againing&&c>=0)return canDump===!0&&inputHistory.push(c),c===4&&"noaction"in state.metadata||processInput(c),prevent(a)}function update(){timer+=deltatime,quittingTitleScreen&&timer/1e3>.3&&(quittingTitleScreen=!1,nextLevel()),againing&&timer>againinterval&&(againing=!1,processInput(-1)),quittingMessageScreen&&timer/1e3>.15&&(quittingMessageScreen=!1,messagetext===""?nextLevel():(messagetext="",textMode=!1,titleScreen=!1,titleMode=curlevel>0?1:0,titleSelected=!1,titleSelection=0,canvasResize(),checkWin())),winning&&timer/1e3>.5&&(winning=!1,nextLevel());if(keybuffer.length>0){keyRepeatTimer+=deltatime;if(keyRepeatTimer>repeatinterval/Math.sqrt(keybuffer.length)){keyRepeatTimer=0,keyRepeatIndex=(keyRepeatIndex+1)%keybuffer.length;var a=keybuffer[keyRepeatIndex];checkKey({keyCode:a},!1)}}autotickinterval>0&&!textMode&&(autotick+=deltatime,autotick>autotickinterval&&(autotick=0,autoTickGame()))}var keyRepeatTimer=0,keyRepeatIndex=0,dragging=!1,rightdragging=!1,columnAdded=!1,m1=1431655765,m2=858993459,m4=252645135,m8=16711935,m16=65535,hff=4294967295,h01=16843009,htmlEntityMap={"&":"&amp;","<":"&lt;",">":"&gt;",'"':"&quot;","'":"&#39;","/":"&#x2F;"};HTMLCanvasElement.prototype.relMouseCoords=relMouseCoords;var mouseCoordX=0,mouseCoordY=0;document.addEventListener("mousedown",onMouseDown,!1),document.addEventListener("mouseup",onMouseUp,!1),document.addEventListener("keydown",onKeyDown,!1),document.addEventListener("keyup",onKeyUp,!1),setInterval(function(){update()},deltatime) 