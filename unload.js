function unloadGame(){state=introstate,level={width:5,height:5,layerCount:2,dat:[1,3,3,1,1,2,2,3,3,1,2,1,2,2,3,3,1,1,2,2,3,2,1,3,2,1,3,2,1,3,1,3,3,1,1,2,2,3,3,1,2,1,2,2,3,3,1,1,2,2],movementMask:[1,3,3,1,1,2,2,3,3,1,2,1,2,2,3,3,1,1,2,2,3,2,1,3,2,1,3,2,1,3,1,3,3,1,1,2,2,3,3,1,2,1,2,2,3,3,1,1,2,2],rigidGroupIndexMask:[],rigidMovementAppliedMask:[],bannedGroup:[]},generateTitleScreen(),canvasResize(),redraw()}function generateTitleScreen(){titleMode=curlevel>0?1:0;if(state.levels.length==0){titleImage=intro_template;return}var a="PuzzleScript Game";state.metadata.title!==undefined&&(a=state.metadata.title.toUpperCase()),titleMode==0?titleSelected?titleImage=deepClone(titletemplate_firstgo_selected):titleImage=deepClone(titletemplate_firstgo):titleSelection==0?titleSelected?titleImage=deepClone(titletemplate_select0_selected):titleImage=deepClone(titletemplate_select0):titleSelected?titleImage=deepClone(titletemplate_select1_selected):titleImage=deepClone(titletemplate_select1);var b="noaction"in state.metadata,c="noundo"in state.metadata,d="norestart"in state.metadata;c&&d?titleImage[11]="..................................":c?titleImage[11]=".R to restart.....................":d&&(titleImage[11]=".Z to undo....................."),b&&(titleImage[10]="..................................");for(var e=0;e<titleImage.length;e++)titleImage[e]=titleImage[e].replace(/\./g," ");var f=titleImage[0].length,g=wordwrap(a,titleImage[0].length);for(var e=0;e<g.length;e++){var h=g[e],i=h.length,j=(f-i)/2|0,k=f-i-j,l=titleImage[1+e];titleImage[1+e]=l.slice(0,j)+h+l.slice(j+h.length)}if(state.metadata.author!==undefined){var m="by "+state.metadata.author;attributionsplit=wordwrap(m,titleImage[0].length);for(var e=0;e<attributionsplit.length;e++){var n=attributionsplit[e],l=titleImage[3+e];titleImage[3+e]=l.slice(0,f-n.length-1)+n+l[l.length-1]}}}function deepClone(a){if(!a)return a;var b=[Number,String,Boolean],c;b.forEach(function(b){a instanceof b&&(c=b(a))});if(typeof c=="undefined")if(Object.prototype.toString.call(a)==="[object Array]")c=[],a.forEach(function(a,b,d){c[b]=deepClone(a)});else if(typeof a=="object")if(a.nodeType&&typeof a.cloneNode=="function")var c=a.cloneNode(!0);else if(!a.prototype)if(a instanceof Date)c=new Date(a);else{c={};for(var d in a)c[d]=deepClone(a[d])}else c=a;else c=a;return c}function wordwrap(a,b){b=b||75;var c=!0;if(!a)return a;var d=".{1,"+b+"}(\\s|$)"+(c?"|.{"+b+"}|.+$":"|\\S+?(\\s|$)");return a.match(RegExp(d,"g"))}function drawMessageScreen(){titleMode=0,textMode=!0,titleImage=deepClone(messagecontainer_template);for(var a=0;a<titleImage.length;a++)titleImage[a]=titleImage[a].replace(/\./g," ");var b=titleImage[0].length,c;if(messagetext===""){var d=state.levels[curlevel];c=d.message.trim()}else c=messagetext;splitMessage=wordwrap(c,titleImage[0].length);for(var a=0;a<splitMessage.length;a++){var e=splitMessage[a],f=5-(splitMessage.length/2|0)+a,g=e.length,h=(b-g)/2|0,i=b-g-h,j=titleImage[f];titleImage[f]=j.slice(0,h)+e+j.slice(h+e.length)}quittingMessageScreen&&(titleImage[10]=titleImage[9]),canvasResize()}function loadLevelFromState(a,b){forceRegenImages=!0,titleScreen=!1,titleMode=curlevel>0?1:0,titleSelected=!1,titleSelection=0,curlevel=b,againing=!1;var c=a.levels[b];if(c===null){consolePrint("Trying to access a level that doesn't exist.");return}if(c.message===undefined){titleMode=0,textMode=!1,level={width:c.w,height:c.h,layerCount:c.layerCount,dat:c.dat.concat([]),movementMask:c.dat.concat([]),rigidMovementAppliedMask:c.dat.concat([]),rigidGroupIndexMask:c.dat.concat([]),rowCellContents:[],colCellContents:[],mapCellContents:0};for(var d=0;d<level.height;d++)level.rowCellContents[d]=0;for(var d=0;d<level.width;d++)level.colCellContents[d]=0;for(var d=0;d<level.movementMask.length;d++)level.movementMask[d]=0,level.rigidMovementAppliedMask[d]=0,level.rigidGroupIndexMask[d]=0;"run_rules_on_level_start"in a.metadata&&processInput(-1,!0),backups=[],restartTarget=backupLevel(),b===0?tryPlayStartLevelSound():tryPlayStartLevelSound()}else tryPlayShowMessageSound(),drawMessageScreen(),canvasResize();canDump===!0&&(inputHistory=[])}function autoTickGame(){processInput(-1)}function tick(){redraw()}function tryPlaySimpleSound(a){if(state.sfx_Events[a]!==undefined){var b=state.sfx_Events[a];playSeed(b)}}function tryPlayTitleSound(){tryPlaySimpleSound("titlescreen")}function tryPlayStartGameSound(){tryPlaySimpleSound("startgame")}function tryPlayEndGameSound(){tryPlaySimpleSound("endgame")}function tryPlayStartLevelSound(){tryPlaySimpleSound("startlevel")}function tryPlayEndLevelSound(){tryPlaySimpleSound("endlevel")}function tryPlayUndoSound(){tryPlaySimpleSound("undo")}function tryPlayRestartSound(){tryPlaySimpleSound("restart")}function tryPlayShowMessageSound(){tryPlaySimpleSound("showmessage")}function tryPlayCloseMessageSound(){tryPlaySimpleSound("closemessage")}function backupLevel(){return level.dat.concat([])}function setGameState(a,b){oldflickscreendat=[],timer=0,autotick=0,winning=!1,againing=!1,messageselected=!1,b===undefined&&(b=["restart"]),state.levels.length==0&&b.length>0&&b[0]==="rebuild"&&(b=["restart"]),state=a,window.console.log("setting game state :D "),backups=[],sprites=[];for(var c in state.objects)if(state.objects.hasOwnProperty(c)){var d=state.objects[c],e={colors:d.colors,dat:d.spritematrix};sprites[d.id]=e}state.metadata.realtime_interval!==undefined?(autotick=0,autotickinterval=state.metadata.realtime_interval*1e3,logBetaMessage("realtime_interval is a beta feature, its behaviour may change before it ends up in launch. I would advise against circulating this game for wider distribution before then.",!0)):(autotick=0,autotickinterval=0),state.metadata.key_repeat_interval!==undefined?repeatinterval=state.metadata.key_repeat_interval*1e3:repeatinterval=150,state.metadata.again_interval!==undefined?againinterval=state.metadata.again_interval*1e3:againinterval=150;switch(b[0]){case"restart":winning=!1,timer=0,titleScreen=!0,tryPlayTitleSound(),textMode=!0,titleSelection=0,titleSelected=!1,quittingMessageScreen=!1,quittingTitleScreen=!1,messageselected=!1,titleMode=0,curlevel>0&&(titleMode=1),generateTitleScreen();break;case"rebuild":break;case"loadLevel":var f=b[1];curlevel=h,winning=!1,timer=0,titleScreen=!1,textMode=!1,titleSelection=0,titleSelected=!1,quittingMessageScreen=!1,quittingTitleScreen=!1,messageselected=!1,titleMode=0,loadLevelFromState(state,f);break;case"levelline":var g=b[1];for(var h=state.levels.length-1;h>=0;h--){var i=state.levels[h];if(i.lineNumber<=g+1){curlevel=h,winning=!1,timer=0,titleScreen=!1,textMode=!1,titleSelection=0,titleSelected=!1,quittingMessageScreen=!1,quittingTitleScreen=!1,messageselected=!1,titleMode=0,loadLevelFromState(state,h);break}}}canDump===!0&&(inputHistory=[]),canvasResize();if(canYoutube&&"youtube"in state.metadata){var j=state.metadata.youtube,k="https://youtube.googleapis.com/v/"+j+"?autoplay=1&loop=1&playlist="+j;ifrm=document.createElement("IFRAME"),ifrm.setAttribute("src",k),ifrm.style.visibility="hidden",ifrm.style.width="500px",ifrm.style.height="500px",ifrm.style.position="absolute",ifrm.style.top="-1000px",ifrm.style.left="-1000px",document.body.appendChild(ifrm)}}function restoreLevel(a){oldflickscreendat=[],level.dat=a.concat([]),level.dat=a.concat([]);for(var b=0;b<level.dat.length;b++)level.movementMask[b]=0,level.rigidMovementAppliedMask[b]=0,level.rigidGroupIndexMask[b]=0;for(var b=0;b<level.height;b++)level.rowCellContents[b]=0;for(var b=0;b<level.width;b++)level.colCellContents[b]=0;againing=!1,messagetext="",level.commandQueue=[],redraw()}function DoRestart(a){if(a===!1&&"norestart"in state.metadata)return;a===!1&&backups.push(backupLevel()),restoreLevel(restartTarget),tryPlayRestartSound(),level.commandQueue=[]}function DoUndo(a){if("noundo"in state.metadata&&a!==!0)return;if(backups.length>0){var b=backups[backups.length-1];restoreLevel(b),backups=backups.splice(0,backups.length-1),tryPlayUndoSound()}}function getPlayerPositions(){var a=[],b=state.playerMask;for(i=0;i<level.dat.length;i++){var c=level.dat[i];(b&c)!=0&&a.push(i)}return a}function getLayersOfMask(a){var b=[];for(var c=0;c<state.objectCount;c++)if((a&1<<c)!=0){var d=state.idDict[c],e=state.objects[d];b.push(e.layer)}return b}function getLayerMask(a){var b=0;for(var c=0;c<state.objectCount;c++)if((a&1<<c)!=0){var d=state.idDict[c],e=state.objects[d];b|=parseInt("11111",2)<<5*e.layer}return b}function moveEntitiesAtIndex(a,b,c){var d=level.dat[a],e=b&d,f=getLayersOfMask(e),g=level.movementMask[a];for(var h=0;h<f.length;h++){var i=f[h];g|=c<<i*5}level.movementMask[a]=g}function startMovement(a){var b=!1,c=getPlayerPositions();for(var d=0;d<c.length;d++){var e=c[d];moveEntitiesAtIndex(e,state.playerMask,a)}return c}function repositionEntitiesOnLayer(a,b,c){var d=dirMasksDelta[c],e=d[0],f=d[1],g=a/level.height|0,h=a%level.height|0,i=level.width-1,j=level.height-1;if(g===0&&e<0||g===i&&e>0||h===0&&f<0||h===j&&f>0)return!1;var k=(a+d[1]+d[0]*level.height)%level.dat.length,l=state.layerMasks[b],m=level.dat[k],n=m&l,o=level.dat[a];if(n!=0)return!1;var p=o&l;level.dat[a]=o&~l,level.dat[k]=m|p;var q=k/level.height|0,r=k%level.height;level.colCellContents[q]=level.colCellContents[q]|p,level.rowCellContents[r]=level.rowCellContents[r]|p,level.mapCellContents=level.mapCellContents|p;for(var s=0;s<state.sfx_MovementMasks.length;s++){var t=state.sfx_MovementMasks[s],u=t.objectMask;if((u&o)!==0){var v=level.movementMask[a],w=t.directionMask;(v&w)!==0&&seedsToPlay_CanMove.indexOf(t.seed)===-1&&seedsToPlay_CanMove.push(t.seed)}}return!0}function randomDir(){return dirMask_random[Math.floor(Math.random()*dirMask_random.length)]}function repositionEntitiesAtCell(a){var b=level.movementMask[a],c=!1;for(var d=0;d<6;d++){var e=parseInt("11111",2)&b>>5*d;if(e!=0){var f=repositionEntitiesOnLayer(a,d,e);f&&(b&=~(e<<5*d)),c=f||c}}return level.movementMask[a]=b,c}function ruleMovementMaskAgrees(a,b){return a===0?!0:(a&b)!==0}function cellRowMatchesWildCard_ParticularK(a,b,c,d){var e=b[0],f=b[1],g=b[2],h=b[4],i=dirMasksDelta[a],j=level.movementMask[c],k=level.dat[c],l,m=[];if((f&k)==f&&(g&k)==0&&(e===0?!0:(e&j)!==0)&&(h&j)==0){var n=c;for(var o=6;o<b.length;o+=6){n=(n+i[1]+i[0]*level.height)%level.dat.length;var j=level.movementMask[n],p=b[o+0],k=level.dat[n],q=b[o+1],r=b[o+2],s=b[o+4];if(p===ellipsisDirection){var t=n;t=(t+i[1]*d+i[0]*d*level.height+level.dat.length)%level.dat.length;for(var u=o+6;u<b.length;u+=6){j=level.movementMask[t],k=level.dat[t],p=b[u+0],q=b[u+1],r=b[u+2],s=b[u+4];if((q&k)!=q||(r&k)!=0||(p===0?!1:(p&j)===0)||(s&j)!=0)break;t=(t+i[1]+i[0]*level.height)%level.dat.length}u>=b.length&&m.push([c,d]);break}if((q&k)!=q||(r&k)!=0||(p===0?!1:(p&j)===0)||(s&j)!=0)break}}return m.length>0}function cellRowMatchesWildCard(a,b,c,d){var e=b[0],f=b[1],g=b[2],h=b[4],i=dirMasksDelta[a],j=level.movementMask[c],k=level.dat[c],l,m=[];if((f&k)==f&&(g&k)==0&&(e===0?!0:(e&j)!==0)&&(h&j)==0){var n=c;for(var o=6;o<b.length;o+=6){n=(n+i[1]+i[0]*level.height)%level.dat.length;var j=level.movementMask[n],p=b[o+0],k=level.dat[n],q=b[o+1],r=b[o+2],s=b[o+4];if(p===ellipsisDirection){for(var t=0;t<d;t++){var u=n;u=(u+i[1]*t+i[0]*t*level.height+level.dat.length)%level.dat.length;for(var v=o+6;v<b.length;v+=6){j=level.movementMask[u],k=level.dat[u],p=b[v+0],q=b[v+1],r=b[v+2],s=b[v+4];if((q&k)!=q||(r&k)!=0||(p===0?!1:(p&j)===0)||(s&j)!=0)break;u=(u+i[1]+i[0]*level.height)%level.dat.length}v>=b.length&&m.push([c,t])}break}if((q&k)!=q||(r&k)!=0||(p===0?!1:(p&j)===0)||(s&j)!=0)break}}return m}function checkThing(a,b,c,d,e,f){return(a&f)==a&&(c&f)==0&&ruleMovementMaskAgrees(b,e)&&(d&e)==0}function cellRowMatches(a,b,c,d){var e=b[0],f=b[1],g=b[2],h=b[4],i=dirMasksDelta[a],j=level.movementMask[c],k=level.dat[c],l;if((f&k)==f&&(g&k)==0&&(e===0?!0:(e&j)!==0)&&(h&j)==0){var m=c;for(var n=6;n<b.length;n+=6){m=(m+i[1]+i[0]*level.height)%level.dat.length;var j=level.movementMask[m],o=b[n+0];o===ellipsisDirection&&(m=(m+i[1]*d+i[0]*d*level.height)%level.dat.length);var k=level.dat[m],p=b[n+1],q=b[n+2],r=b[n+4];if((p&k)!=p||(q&k)!=0||(o===0?!1:(o&j)===0)||(r&j)!=0)break}if(n>=b.length)return!0}return!1}function matchCellRow(a,b,c){var d=[];if((c&level.mapCellContents)===0)return d;var e=0,f=level.width,g=0,h=level.height,i=b.length/6|0;switch(a){case 1:g+=i-1;break;case 2:h-=i-1;break;case 4:e+=i-1;break;case 8:f-=i-1;break;default:window.console.log("EEEP "+a)}var j=a>2;if(j)for(var k=g;k<h;k++){if((level.rowCellContents[k]&c)===0)continue;for(var l=e;l<f;l++){var m=l*level.height+k;cellRowMatches(a,b,m)&&d.push(m)}}else for(var l=e;l<f;l++){if((level.colCellContents[l]&c)===0)continue;for(var k=g;k<h;k++){var m=l*level.height+k;cellRowMatches(a,b,m)&&d.push(m)}}return d}function matchCellRowWildCard(a,b,c){var d=[];if((c&level.mapCellContents)===0)return d;var e=0,f=level.width,g=0,h=level.height,i=(b.length/6|0)-1;switch(a){case 1:g+=i-1;break;case 2:h-=i-1;break;case 4:e+=i-1;break;case 8:f-=i-1;break;default:window.console.log("EEEP2 "+a)}var j=a>2;if(j)for(var k=g;k<h;k++){if((level.rowCellContents[k]&c)===0)continue;for(var l=e;l<f;l++){var m=l*level.height+k,n;switch(a){case 1:n=k-i+2;break;case 2:n=level.height-(k+i)+1;break;case 4:n=l-i+2;break;case 8:n=level.width-(l+i)+1;break;default:window.console.log("EEEP2 "+a)}d=d.concat(cellRowMatchesWildCard(a,b,m,n))}}else for(var l=e;l<f;l++){if((level.colCellContents[l]&c)===0)continue;for(var k=g;k<h;k++){var m=l*level.height+k,n;switch(a){case 1:n=k-i+2;break;case 2:n=level.height-(k+i)+1;break;case 4:n=l-i+2;break;case 8:n=level.width-(l+i)+1;break;default:window.console.log("EEEP2 "+a)}d=d.concat(cellRowMatchesWildCard(a,b,m,n))}}return d}function generateTuples(a){var b=[[]];for(var c=0;c<a.length;c++){var d=a[c],e=[];for(var f=0;f<d.length;f++){var g=d[f];for(var h=0;h<b.length;h++){var i=b[h],j=i.concat([g]);e.push(j)}}b=e}return b}function commitPreservationState(a){var b={ruleGroupIndex:a,dat:level.dat.concat([]),levelMovementMask:level.movementMask.concat([]),rigidGroupIndexMask:level.rigidGroupIndexMask.concat([]),rigidMovementAppliedMask:level.rigidMovementAppliedMask.concat([]),bannedGroup:level.bannedGroup.concat([])};return rigidBackups[a]=b,b}function restorePreservationState(a){level.dat=a.dat.concat([]),level.movementMask=a.levelMovementMask.concat([]),level.rigidGroupIndexMask=a.rigidGroupIndexMask.concat([]),level.rigidMovementAppliedMask=a.rigidMovementAppliedMask.concat([]),sfxCreateMask=0,sfxDestroyMask=0}function findRuleMatches(a){var b=[],c=a[11];for(var d=0;d<a[1].length;d++){var e=a[1][d];if(a[5][d])var f=matchCellRowWildCard(a[0],e,c[d]);else var f=matchCellRow(a[0],e,c[d]);if(f.length==0)return[];b.push(f)}return b}function applyRuleAt(a,b,c,d){if(d){var e=!0;for(var f=0;f<a[1].length;f++)if(a[5][f]){if(cellRowMatchesWildCard_ParticularK(a[0],a[1][f],c[f][0],c[f][1])===!1){e=!1;break}}else if(cellRowMatches(a[0],a[1][f],c[f])===!1){e=!1;break}if(e===!1)return!1}var g=!1,h=!1;for(var f=0;f<a[1].length;f++){var i=a[1][f],j=a[2][f],k=a[5][f]?c[f][0]:c[f];for(var l=0;l<i.length;l+=6){var m=i[l+0];if(m===ellipsisDirection){var n=c[f][1];k=(k+b[1]*n+b[0]*n*level.height)%level.dat.length;continue}var o=i[l+1],p=i[l+2],q=i[l+3],r=i[l+4],s=j[l+0],t=j[l+1],u=j[l+2],v=j[l+3],w=j[l+4],x=j[l+5],y=i[l+5];if(x!==0){var z=[];for(var A=0;A<32;A++)(x&1<<A)!==0&&z.push(A);var B=z[Math.floor(Math.random()*z.length)],C=state.idDict[B],D=state.objects[C],E=state.layerMasks[D.layer],F=31<<5*D.layer;t|=1<<B,u|=state.layerMasks[D.layer],w|=F}if(y!==0)for(var G=0;G<6;G++){var H=parseInt("11111",2)&y>>5*G;if(H!==0){var I=randomDir();s|=I<<5*G}}var J=level.dat[k],K=level.movementMask[k],L=J,M=K;J&=~o,K&=~m,J&=~u,K&=~q,s!==0&&(K&=~v),J|=t,K&=~w,K|=s;var N=!1,O=0,P=0;if(a[7]){h=!0;var Q=a[6],R=state.groupNumber_to_RigidGroupIndex[Q];R++;var S=R+(R<<5)+(R<<10)+(R<<15)+(R<<20)+(R<<25);S&=v,O=level.rigidGroupIndexMask[k],P=level.rigidMovementAppliedMask[k];var T=O,U=P;O|=S,P|=v;if(T!==O||U!==P)N=!0}if(L!==J||M!=K||N){g=!0,N&&(level.rigidGroupIndexMask[k]=O,level.rigidMovementAppliedMask[k]=P);var V=J&~L,W=L&~J;sfxCreateMask|=V,sfxDestroyMask|=W,level.dat[k]=J,level.movementMask[k]=K;var X=k/level.height|0,Y=k%level.height;level.colCellContents[X]=level.colCellContents[X]|J,level.rowCellContents[Y]=level.rowCellContents[Y]|J,level.mapCellContents=level.mapCellContents|J}k=(k+b[1]+b[0]*level.height)%level.dat.length}}if(verbose_logging&&g){var Z=a[3],$=dirMaskName[a[0]],_='<font color="green">Rule <a onclick="jumpToLine('+Z.toString()+');" href="javascript:void(0);">'+Z.toString()+"</a> applied.</font>";consolePrint(_)}return g}function tryApplyRule(a,b,c){var d=dirMasksDelta[a[0]],e=findRuleMatches(a);if(e.length===0)return!1;var f=!1;if(a[9]===!1){var g=generateTuples(e);for(var h=0;h<g.length;h++){var i=g[h],j=h>0;f=applyRuleAt(a,d,i,j)||f}}return e.length>0&&queueCommands(a),f}function queueCommands(a){var b=a[8];for(var c=0;c<b.length;c++){var d=b[c],e=!1;if(level.commandQueue.indexOf(d[0])>=0)continue;level.commandQueue.push(d[0]),d[0]==="message"&&(messagetext=d[1])}}function showTempMessage(){keybuffer=[],textMode=!0,titleScreen=!1,quittingMessageScreen=!1,messageselected=!1,tryPlayShowMessageSound(),drawMessageScreen(),canvasResize()}function applyRandomRuleGroup(a){var b=!1,c=[];for(var d=0;d<a.length;d++){var e=a[d],f=findRuleMatches(e);if(f.length>0){var g=generateTuples(f);for(var h=0;h<g.length;h++){var i=g[h];c.push([d,i])}}}if(c.length==0)return!1;var j=c[Math.floor(Math.random()*c.length)],d=j[0],e=a[d],k=dirMasksDelta[e[0]],i=j[1],l=!1,m=applyRuleAt(e,k,i,l);return queueCommands(e),m}function applyRuleGroup(a){var b=a[0][10];if(b)return applyRandomRuleGroup(a);var c=!1,d=!0,e=0;while(d){e++;if(e>200){logErrorNoLine("got caught looping lots in a rule group :O",!0);break}d=!1;for(var f=0;f<a.length;f++){var g=a[f];d=tryApplyRule(g)||d}d&&(c=!0)}return c}function propagateMovements(a){var b=a>0,c=0;for(var d=a;d<state.rules.length;){if(!level.bannedGroup[d]){var e=state.rules[d];b=applyRuleGroup(e)||b}if(b&&state.loopPoint[d]!==undefined){d=state.loopPoint[d],b=!1,c++;if(c>200){var e=state.rules[d];logError("got caught in an endless startloop...endloop vortex, escaping!",e[0][3],!0);break}}else{d++;if(d===state.rules.length&&b&&state.loopPoint[d]!==undefined){d=state.loopPoint[d],b=!1,c++;if(c>200){var e=state.rules[d];logError("got caught in an endless startloop...endloop vortex, escaping!",e[0][3],!0);break}}}}}function propagateLateMovements(){var a=!0,b=0;for(var c=0;c<state.lateRules.length;){if(!level.bannedGroup[c]){var d=state.lateRules[c],e=applyRuleGroup(d);a=e||a}if(a&&state.lateLoopPoint[c]!==undefined){c=state.lateLoopPoint[c],a=!1,b++;if(b>200){var d=state.lateRules[c];logError("got caught in an endless startloop...endloop vortex, escaping!",d[0][3],!0);break}}else{c++;if(c===state.lateRules.length&&a&&state.lateLoopPoint[c]!==undefined){c=state.lateLoopPoint[c],a=!1,b++;if(b>0){var d=state.lateRules[c];logError("got caught in an endless startloop...endloop vortex, escaping!",d[0][3],!0);break}}}}}function resolveMovements(a){var b=!0;while(b){b=!1;for(var c=0;c<level.dat.length;c++){var d=level.movementMask[c];d!=0&&(b=repositionEntitiesAtCell(c)||b)}}var e=!1;for(var c=0;c<level.movementMask.length;c++){var f=level.dat[c],d=level.movementMask[c];if(d!==0){var g=level.rigidMovementAppliedMask[c],h=g&d;if(h!==0)for(var i=0;i<6;i++){var j=parseInt("11111",2)&h>>5*i;if(j!==0){var k=level.rigidGroupIndexMask[c],l=parseInt("11111",2)&k>>5*i;l--;var m=state.rigidGroupIndex_to_GroupIndex[l];level.bannedGroup[m]=!0,e=!0;break}}for(var i=0;i<state.sfx_MovementFailureMasks.length;i++){var n=state.sfx_MovementFailureMasks[i],o=n.objectMask;if((o&f)!==0){var p=n.directionMask;(d&p)!==0&&seedsToPlay_CantMove.indexOf(n.seed)===-1&&seedsToPlay_CantMove.push(n.seed)}}}level.movementMask[c]=0,level.rigidGroupIndexMask[c]=0,level.rigidMovementAppliedMask[c]=0}return e}function calculateRowColMasks(){level.mapCellContents=0;for(var a=0;a<level.width;a++)level.colCellContents[a]=0;for(var b=0;b<level.height;b++)level.rowCellContents[a]=0;for(var a=0;a<level.width;a++)for(var b=0;b<level.height;b++){var c=b+a*level.height,d=level.dat[c];level.mapCellContents=level.mapCellContents|d,level.rowCellContents[b]=level.rowCellContents[b]|d,level.colCellContents[a]=level.colCellContents[a]|d}}function processInput(a,b,c){verbose_logging&&(a===-1?consolePrint("Turn starts with no input."):(consolePrint("======================="),consolePrint("Turn starts with input of "+["up","left","down","right","action"][a]+".")));var d=backupLevel(),e=[];if(a<=4){if(a>=0){switch(a){case 0:a=parseInt("00001",2);break;case 1:a=parseInt("00100",2);break;case 2:a=parseInt("00010",2);break;case 3:a=parseInt("01000",2);break;case 4:a=parseInt("10000",2)}e=startMovement(a)}var f=0,g=!0;level.bannedGroup=[],rigidBackups=[],level.commandQueue=[];var h=0,i=!1,j=commitPreservationState();messagetext="",sfxCreateMask=0,sfxDestroyMask=0,seedsToPlay_CanMove=[],seedsToPlay_CantMove=[],calculateRowColMasks();while(g||i){g=!1,i=!1,f++,verbose_logging&&consolePrint("applying rules"),propagateMovements(h);var k=resolveMovements();k?(i=!0,restorePreservationState(j),h=0):(verbose_logging&&consolePrint("applying late rules"),propagateLateMovements(),h=0)}f>=50&&window.console.log("looped through 50 times, gave up. too many loops!");for(var f=0;f<seedsToPlay_CantMove.length;f++)playSeed(seedsToPlay_CantMove[f]);if(e.length>0&&state.metadata.require_player_movement!==undefined){var l=!1;for(var f=0;f<e.length;f++){var m=e[f],n=level.dat[m];if((n&state.playerMask)===0){l=!0;break}}if(l===!1){consolePrint("require_player_movement set, but no player movement detected, so cancelling turn."),backups.push(d),DoUndo(!0),seedsToPlay_CanMove=[],seedsToPlay_CantMove=[];return}}if(level.commandQueue.indexOf("cancel")>=0){verbose_logging&&consolePrint("CANCEL command executed, cancelling turn."),backups.push(d),DoUndo(!0),seedsToPlay_CanMove=[],seedsToPlay_CantMove=[],redraw();return}if(level.commandQueue.indexOf("restart")>=0)return verbose_logging&&consolePrint("RESTART command executed, reverting to restart state."),backups.push(d),DoRestart(!0),seedsToPlay_CanMove=[],seedsToPlay_CantMove=[],redraw(),!0;for(var f=0;f<seedsToPlay_CanMove.length;f++)playSeed(seedsToPlay_CanMove[f]);for(var f=0;f<state.sfx_CreationMasks.length;f++){var o=state.sfx_CreationMasks[f];(sfxCreateMask&o.objectMask)!==0&&playSeed(o.seed)}for(var f=0;f<state.sfx_DestructionMasks.length;f++){var o=state.sfx_DestructionMasks[f];(sfxDestroyMask&o.objectMask)!==0&&playSeed(o.seed)}for(var f=0;f<level.movementMask.length;f++)level.movementMask[f]=0,level.rigidGroupIndexMask[f]=0,level.rigidMovementAppliedMask[f]=0;var p=!1;for(var f=0;f<level.dat.length;f++)if(level.dat[f]!==d[f]){if(c)return backups.push(d),DoUndo(!0),!0;a!==-1&&backups.push(d),p=!0;break}if(c)return!1;for(var f=0;f<level.commandQueue.length;f++){var q=level.commandQueue[f];q.charAt(1)==="f"&&tryPlaySimpleSound(q),unitTesting===!1&&q==="message"&&showTempMessage()}level.commandQueue.indexOf("again")>=0&&p&&processInput(-1,!0,!0)&&(verbose_logging&&consolePrint("AGAIN command executed, with changes detected: will execute another turn."),againing=!0,timer=0),level.commandQueue.indexOf("checkpoint")>=0&&(verbose_logging&&consolePrint("CHECKPOINT command executed, saving current state to the restart state."),restartTarget=backupLevel()),textMode===!1&&(b===undefined||b===!1)&&(verbose_logging&&consolePrint("Checking win condition."),checkWin()),level.commandQueue=[]}redraw()}function checkWin(){if(levelEditorOpened)return;if(level.commandQueue.indexOf("win")>=0){consolePrint("Win Condition Satisfied"),DoWin();return}var a=!1;if(state.winconditions.length>0){var b=!0;for(var c=0;c<state.winconditions.length;c++){var d=state.winconditions[c],e=d[1],f=d[2],g=!0;switch(d[0]){case-1:for(var h=0;h<level.dat.length;h++){var i=level.dat[h];if((e&i)!==0&&(f&i)!==0){g=!1;break}}break;case 0:var j=!1;for(var h=0;h<level.dat.length;h++){var i=level.dat[h];if((f&i)!==0&&(e&i)!==0){j=!0;break}}j===!1&&(g=!1);break;case 1:for(var h=0;h<level.dat.length;h++){var i=level.dat[h];if((e&i)!==0&&(f&i)===0){g=!1;break}}}g===!1&&(b=!1)}a=b}a&&(consolePrint("Win Condition Satisfied"),DoWin())}function DoWin(){if(winning)return;againing=!1,tryPlayEndLevelSound();if(unitTesting){nextLevel();return}winning=!0,timer=0}function anyMovements(){for(var a=0;a<level.movementMask.length;a++)if(level.movementMask[a]!=0)return!0;return!1}function nextLevel(){keybuffer=[],againing=!1,messagetext="",titleScreen?(titleSelection==0&&(curlevel=0),loadLevelFromState(state,curlevel)):curlevel<state.levels.length-1?(curlevel++,textMode=!1,titleScreen=!1,quittingMessageScreen=!1,messageselected=!1,loadLevelFromState(state,curlevel)):(curlevel=0,goToTitleScreen(),tryPlayEndGameSound()),localStorage[document.URL]=curlevel,canvasResize(),canDump===!0&&(inputHistory=[])}function goToTitleScreen(){againing=!1,messagetext="",titleScreen=!0,textMode=!0,titleSelection=0,generateTitleScreen()}intro_template=["..................................","..................................","..................................","......Puzzle Script Terminal......","..............v 1.0...............","..................................","..................................","..................................",".........insert cartridge.........","..................................","..................................","..................................",".................................."],messagecontainer_template=["..................................","..................................","..................................","..................................","..................................","..................................","..................................","..................................","..................................","..................................","..........X to continue...........","..................................",".................................."],titletemplate_firstgo=["..................................","..................................","..................................","..................................","..................................","..................................","..........#.start game.#..........","..................................","..................................",".arrow keys to move...............",".X to action......................",".Z to undo, R to restart..........",".................................."],titletemplate_select0=["..................................","..................................","..................................","..................................","..................................","...........#.new game.#...........","..................................",".............continue.............","..................................",".arrow keys to move...............",".X to action......................",".Z to undo, R to restart..........",".................................."],titletemplate_select1=["..................................","..................................","..................................","..................................","..................................",".............new game.............","..................................","...........#.continue.#...........","..................................",".arrow keys to move...............",".X to action......................",".Z to undo, R to restart..........",".................................."],titletemplate_firstgo_selected=["..................................","..................................","..................................","..................................","..................................","..................................","###########.start game.###########","..................................","..................................",".arrow keys to move...............",".X to action......................",".Z to undo, R to restart..........",".................................."],titletemplate_select0_selected=["..................................","..................................","..................................","..................................","..................................","############.new game.############","..................................",".............continue.............","..................................",".arrow keys to move...............",".X to action......................",".Z to undo, R to restart..........",".................................."],titletemplate_select1_selected=["..................................","..................................","..................................","..................................","..................................",".............new game.............","..................................","############.continue.############","..................................",".arrow keys to move...............",".X to action......................",".Z to undo, R to restart..........",".................................."];var titleImage=[],titleWidth=titletemplate_select1[0].length,titleHeight=titletemplate_select1.length,textMode=!0,titleScreen=!0,titleMode=0,titleSelection=0,titleSelected=!1,introstate={title:"2D Whale World",attribution:"increpare",objectCount:2,metadata:[],levels:[],bgcolor:"#000000",fgcolor:"#FFFFFF"},state=introstate,splitMessage=[],sprites=[{color:"#423563",dat:[[1,1,1,1,1],[1,0,0,0,1],[1,0,0,0,1],[1,0,0,0,1],[1,1,1,1,1]]},{color:"#252342",dat:[[0,0,1,0,0],[1,1,1,1,1],[0,0,1,0,0],[0,1,1,1,0],[0,1,0,1,0]]}];generateTitleScreen(),canvasResize();var backups=[],restartTarget,messagetext="",zoomscreen=!1,flickscreen=!1,screenwidth=0,screenheight=0,dirMasksDelta={1:[0,-1],2:[0,1],4:[-1,0],8:[1,0],15:[0,0],16:[0,0],3:[0,0]},dirMaskName={1:"up",2:"down",4:"left",8:"right",15:"?",16:"action",3:"no"},seedsToPlay_CanMove=[],seedsToPlay_CantMove=[],dirMask_random=[parseInt("00001",2),parseInt("00010",2),parseInt("00100",2),parseInt("01000",2)],randomDirMask=parseInt("00101",2),ellipsisDirection=1<<31,randomEntityMask=parseInt("00101",2);propagationState={ruleGroupIndex:0,levelDat:[],levelMovementMask:[],rigidGroupIndexMask:[],rigidMovementAppliedMask:[],bannedGroup:[]};var rigidBackups=[],sfxCreateMask=0,sfxDestroyMask=0 