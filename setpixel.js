function setPixel(a,b,c,d,e,f,g){index=(b+c*a.width)*4,a.data[index+0]=d,a.data[index+1]=e,a.data[index+2]=f,a.data[index+3]=g}function createSprite(a,b,c){b.clearRect(0,0,cellwidth,cellheight);var d=font[c],e=5,f=5,g=~~(cellwidth/6),h=~~(cellheight/6),i=h;"scanline"in state.metadata&&(i=Math.ceil(h/2)),b.fillStyle=state.fgcolor;for(var j=0;j<e;j++)for(var k=0;k<f;k++){var l=~~(j*g),m=~~(k*h);d[j][k]==1&&b.fillRect(m,l,g,i)}var n=a.toDataURL(),o=document.createElement("img");return o.onload=redraw,o.src=n,o}function regenText(a,b){textImages={};for(var c in font)font.hasOwnProperty(c)&&(textImages[c]=createSprite(a,b,c))}function regenSpriteImages(){var a=document.createElement("canvas");a.width=cellwidth,a.height=cellheight;var b=a.getContext("2d"),c=5,d=5,e=~~(cellwidth/c),f=~~(cellheight/d);regenText(a,b);if(state.levels.length===0)return;spriteimages=[];for(var g=0;g<sprites.length;g++){if(sprites[g]==undefined)continue;b.clearRect(0,0,cellwidth,cellheight);var h=sprites[g].dat,i=f;"scanline"in state.metadata&&(i=Math.ceil(f/2));var j=sprites[g].colors;for(var k=0;k<c;k++)for(var l=0;l<d;l++){var m=h[k][l];if(m>=0){var n=k*e|0,o=l*f|0;b.fillStyle=j[m],b.fillRect(o,n,e,i)}}var p=a.toDataURL(),q=document.createElement("img");q.onload=redraw,q.src=p,spriteimages[g]=q}canOpenEditor&&generateGlyphImages(a,b)}function generateGlyphImages(a,b){glyphImagesCorrespondance=[],glyphImages=[];for(var c in state.glyphDict)if(c.length==1&&state.glyphDict.hasOwnProperty(c)){var d=state.glyphDict[c];glyphImagesCorrespondance.push(c),b.clearRect(0,0,cellwidth,cellheight);for(var e=0;e<d.length;e++){var f=d[e];if(f===-1)continue;var g=spriteimages[f];b.drawImage(g,0,0)}var h=a.toDataURL(),i=document.createElement("img");i.onload=redraw,i.src=h,glyphImages.push(i)}b.fillStyle="#FFFFFF",b.clearRect(0,0,cellwidth,cellheight),b.fillRect(0,0,cellwidth,1),b.fillRect(0,0,1,cellheight),b.fillRect(0,cellheight-1,cellwidth,1),b.fillRect(cellwidth-1,0,1,cellheight);var h=a.toDataURL(),i=document.createElement("img");i.onload=redraw,i.src=h,glyphHighlight=i,glyphPrintButton=createSprite(a,b,"s"),b.fillStyle="#FFFFFF",b.clearRect(0,0,cellwidth,cellheight);var j=cellwidth/2-1|0,k=cellwidth-j-1-j,l=cellheight/2-1|0,m=cellheight-l-1-j;b.fillRect(j,0,k,cellheight),b.fillRect(0,l,cellwidth,m);var h=a.toDataURL(),i=document.createElement("img");i.onload=redraw,i.src=h,glyphHighlightResize=i,b.fillStyle="yellow",b.clearRect(0,0,cellwidth,cellheight),b.fillRect(0,0,cellwidth,2),b.fillRect(0,0,2,cellheight),b.fillRect(0,cellheight-2,cellwidth,2),b.fillRect(cellwidth-2,0,2,cellheight);var h=a.toDataURL(),i=document.createElement("img");i.onload=redraw,i.src=h,glyphMouseOver=i}function glyphCount(){var a=0;for(var b in state.glyphDict)b.length==1&&state.glyphDict.hasOwnProperty(b)&&a++;return a}function redraw(){if(textMode){for(var a in textImages)if(textImages.hasOwnProperty(a)){var b=textImages[a];if(!b.complete)return;if(b.width===0||b.height===0)return}ctx.fillStyle=state.bgcolor,ctx.fillRect(0,0,canvas.width,canvas.height);for(var c=0;c<titleWidth;c++)for(var d=0;d<titleHeight;d++){var e=titleImage[d].charAt(c);if(e in textImages){var f=textImages[e];ctx.drawImage(f,xoffset+c*cellwidth,yoffset+d*cellheight)}}return}spriteimages===undefined&&regenSpriteImages();for(var c=0;c<spriteimages.length;c++){var b=spriteimages[c];if(b==undefined)continue;if(!b.complete)return}ctx.fillStyle=state.bgcolor,ctx.fillRect(0,0,canvas.width,canvas.height);var g=0,h=screenwidth,i=0,j=screenheight;if(levelEditorOpened){var k=glyphCount();editorRowCount=Math.ceil(k/(screenwidth-1)),h-=2,j-=2+editorRowCount}else if(flickscreen){var l=getPlayerPositions();if(l.length>0){var m=l[0],n=m/level.height|0,o=m%level.height|0,p=n/screenwidth|0,q=o/screenheight|0;g=p*screenwidth,i=q*screenheight,h=Math.min(g+screenwidth,level.width),j=Math.min(i+screenheight,level.height),oldflickscreendat=[g,i,h,j]}else oldflickscreendat.length>0&&(g=oldflickscreendat[0],i=oldflickscreendat[1],h=oldflickscreendat[2],j=oldflickscreendat[3])}else if(zoomscreen){var l=getPlayerPositions();if(l.length>0){var m=l[0],n=m/level.height|0,o=m%level.height|0;g=Math.max(n-(screenwidth/2|0),0),i=Math.max(o-(screenheight/2|0),0),h=Math.min(g+screenwidth,level.width),j=Math.min(i+screenheight,level.height),oldflickscreendat=[g,i,h,j]}else oldflickscreendat.length>0&&(g=oldflickscreendat[0],i=oldflickscreendat[1],h=oldflickscreendat[2],j=oldflickscreendat[3])}for(var c=g;c<h;c++)for(var d=i;d<j;d++){var r=d+c*level.height,s=level.dat[r];for(var t=0;t<state.objectCount;t++){var u=1<<t;if((s&u)!=0){var f=spriteimages[t];ctx.drawImage(f,xoffset+(c-g)*cellwidth,yoffset+(d-i)*cellheight)}}}levelEditorOpened&&drawEditorIcons()}function drawEditorIcons(){var a=glyphImages.length,b=0,c=glyphImages.length,d=c-b;ctx.drawImage(glyphPrintButton,xoffset-cellwidth,yoffset-cellheight*(1+editorRowCount)),mouseCoordY===-1-editorRowCount&&mouseCoordX===-1&&ctx.drawImage(glyphMouseOver,xoffset-cellwidth,yoffset-cellheight*(1+editorRowCount));var e=editorRowCount-(-mouseCoordY-2)-1,f=mouseCoordX+(screenwidth-1)*e;for(var g=0;g<d;g++){var h=b+g,i=glyphImages[h],j=g%(screenwidth-1),e=g/(screenwidth-1)|0;ctx.drawImage(i,xoffset+j*cellwidth,yoffset+e*cellheight-cellheight*(1+editorRowCount)),mouseCoordX>=0&&mouseCoordX<screenwidth-1&&f===g&&ctx.drawImage(glyphMouseOver,xoffset+j*cellwidth,yoffset+e*cellheight-cellheight*(1+editorRowCount)),g===glyphSelectedIndex&&ctx.drawImage(glyphHighlight,xoffset+j*cellwidth,yoffset+e*cellheight-cellheight*(1+editorRowCount))}mouseCoordX>=-1&&mouseCoordY>=-1&&mouseCoordX<screenwidth-1&&mouseCoordY<screenheight-1-editorRowCount&&(mouseCoordX==-1||mouseCoordY==-1||mouseCoordX==screenwidth-2||mouseCoordY===screenheight-2-editorRowCount?ctx.drawImage(glyphHighlightResize,xoffset+mouseCoordX*cellwidth,yoffset+mouseCoordY*cellheight):ctx.drawImage(glyphHighlight,xoffset+mouseCoordX*cellwidth,yoffset+mouseCoordY*cellheight))}function canvasResize(){canvas.style.width=canvas.parentNode.clientWidth,canvas.style.height=canvas.parentNode.clientHeight,canvas.width=canvas.parentNode.clientWidth,canvas.height=canvas.parentNode.clientHeight,screenwidth=level.width,screenheight=level.height;if(state!==undefined){flickscreen=state.metadata.flickscreen!==undefined,zoomscreen=state.metadata.zoomscreen!==undefined;if(levelEditorOpened){screenwidth+=2;var a=glyphCount();editorRowCount=Math.ceil(a/(screenwidth-1)),screenheight+=2+editorRowCount}else flickscreen?(screenwidth=state.metadata.flickscreen[0],screenheight=state.metadata.flickscreen[1]):zoomscreen&&(screenwidth=state.metadata.zoomscreen[0],screenheight=state.metadata.zoomscreen[1])}textMode&&(levelEditorOpened=!1,screenwidth=titleWidth,screenheight=titleHeight),cellwidth=canvas.width/screenwidth,cellheight=canvas.height/screenheight;var b=5,c=5;textMode&&(b=6,c=6),cellwidth=b*~~(cellwidth/b),cellheight=c*~~(cellheight/c),xoffset=0,yoffset=0,cellwidth>cellheight?(cellwidth=cellheight,xoffset=(canvas.width-cellwidth*screenwidth)/2,yoffset=(canvas.height-cellheight*screenheight)/2):(cellheight=cellwidth,yoffset=(canvas.height-cellheight*screenheight)/2,xoffset=(canvas.width-cellwidth*screenwidth)/2),magnification=cellwidth/b*5|0,levelEditorOpened&&(xoffset+=cellwidth,yoffset+=cellheight*(1+editorRowCount)),cellwidth|=0,cellheight|=0,xoffset|=0,yoffset|=0;if(oldcellwidth!=cellwidth||oldcellheight!=cellheight||oldtextmode!=textMode||forceRegenImages)forceRegenImages=!1,regenSpriteImages();oldcellheight=cellheight,oldcellwidth=cellwidth,oldtextmode=textMode,redraw()}var spriteimages,glyphImagesCorrespondance,glyphImages,glyphHighlight,glyphHighlightResize,glyphPrintButton,glyphMouseOver,glyphSelectedIndex=0,editorRowCount=1,canvas,ctx,x,y,cellwidth,cellheight,magnification,xoffset,yoffset;window.console.log("init"),window.addEventListener("resize",canvasResize,!1),canvas=document.getElementById("gameCanvas"),ctx=canvas.getContext("2d"),x=0,y=0;var lastDownTarget,oldcellwidth=0,oldcellheight=0,oldtextmode=-1,forceRegenImages=!1